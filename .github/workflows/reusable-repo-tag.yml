name: ðŸ·ï¸Tag Repository

on:
  workflow_call:
    inputs:
      repository:
        description: "Repository Owner/Name; octocat/Hello-World"
        type: string
        required: true
      ref-name:
        description: "Reference name; branch, tag, etc"
        type: string
        required: true
      github-tag:
        description: "Reference to tag with"
        type: string
        required: true
      debug:
        description: "Debug Mode, won't set tag"
        type: boolean
        required: false
    secrets:
      PAT:
        description: "Personal Access Token"
        required: true

jobs:
  tag-repo:
    name: ðŸ·ï¸Tag Repository
    runs-on: ${{ matrix.os-name }}

    strategy:
      matrix:
        # CHECKME: OS List to run on
        os-name: [
          # ubuntu-latest,  # ubuntu-22.04
          ubuntu-22.04,
        ]

    steps:
      - name: ðŸ·ï¸Tag Repository
        uses: actions/github-script@v7.0.1
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            const debug = ${{ inputs.debug }};
            const repository = '${{ inputs.repository }}';
            const owner = repository.substring(0,repository.indexOf('/'));
            const repo = repository.substring(repository.indexOf('/')+1);
            // get git tag
            const gitTag = '${{ inputs.github-tag }}';
            console.log('Repo Data: ', '${{ inputs.repo-owner }}/${{ inputs.repo-name }}@${{ inputs.ref-name }}')
            console.log('Git tag:   ', gitTag)
            if(gitTag == '') {
              let msg = 'Result:    ðŸ”´No Git Tag sent, aborting!';
              console.log(msg)
              core.setFailed(msg)
              return
            }
            // get latest commit
            const latestCommit = await github.rest.git.getRef({
              owner: owner,
              repo: repo,
              ref: '${{ inputs.ref-name }}'
            })
            // get latest refs
            const latestRefs = await github.rest.git.listMatchingRefs({
              owner: owner,
              repo: repo
            })
            let latestTag = ''; // bucket for latest tag
            // get last tag in data
            for(let thisRef of latestRefs.data) {
              if(thisRef['ref'].indexOf('tags') > -1) {
                let refParts = thisRef['ref'].split('/');
                latestTag = refParts[-1];
              }
            }
            console.log('Latest tag:', latestTag)
            if(latestTag != gitTag) {
              if(debug) {
                console.log(`DEBUG:     ðŸ”µCreating '${gitTag}' tag`)
              } else {
                console.log(`Result:    ðŸŸ¢Creating '${gitTag}' tag`)
                github.rest.git.createRef({
                  owner: owner,
                  repo: repo,
                  ref: `refs/tags/${gitTag}`,
                  sha: latestCommit.data.object.sha
                })
              }
            } else {
              console.log('Result:    ðŸŸ¡Not creating release tag')
            }
